#!/bin/bash -e

source $OPENSHIFT_CARTRIDGE_SDK_BASH

HTTPD_CFG_FILE=$OPENSHIFT_RUBY_DIR/etc/conf/httpd_nolog.conf

function start() {
    echo "Starting Ruby cart"
    /usr/bin/scl enable ruby193 "/usr/sbin/httpd -C 'Include $OPENSHIFT_RUBY_DIR/etc/conf.d/*.conf' -f $HTTPD_CFG_FILE -k start"
}

function stop() {
    echo "Stopping Ruby cart"

    CART_CONF_DIR=${OPENSHIFT_RUBY_DIR}/etc/conf

    # Stop the app
    # src_user_hook pre_stop_${cartridge_type}
    app_userid=`id -u`
    httpd_pid=`cat ${OPENSHIFT_RUBY_DIR}/run/httpd.pid 2> /dev/null`

    /usr/bin/scl enable ruby193 "/usr/sbin/httpd -C 'Include $OPENSHIFT_RUBY_DIR/etc/conf.d/*.conf' -f $HTTPD_CFG_FILE -k stop"

    for i in {1..20}
    do
        if `ps --pid $httpd_pid > /dev/null 2>&1`  ||  \
           `pgrep -u $app_userid Passenger.* > /dev/null 2>&1`
        then
            if [ $i -gt 4 ]
            then
                if `ps --pid $httpd_pid > /dev/null 2>&1`
                then
                    if [ $i -gt 16 ]
                    then
                        /bin/kill -9 $httpd_pid
                    fi
                elif `pgrep -u $app_userid Passenger.* > /dev/null 2>&1`
                then
                    pkill -9 -u $app_userid Passenger.*
                    break
                fi
            fi
            echo "Waiting for stop to finish"
            sleep .5
        else
            break
        fi
    done

}

function restart() {
    echo "${1}ing Ruby cart"
    touch $OPENSHIFT_REPO_DIR/tmp/restart.txt
    /usr/bin/scl enable ruby193 "/usr/sbin/httpd -C 'Include $OPENSHIFT_RUBY_DIR/etc/conf.d/*.conf' -f $HTTPD_CFG_FILE -k restart"
}

function status() {
   echo "Ruby cart status"
}

function tidy() {
    if [ -d $OPENSHIFT_RUBY_LOG_DIR ]
    then
        client_message "Emptying log dir: ${OPENSHIFT_RUBY_LOG_DIR}"
        rm -rf ${OPENSHIFT_RUBY_LOG_DIR}/* ${OPENSHIFT_RUBY_LOG_DIR}/.[^.]*
    fi

    if [ -d ${OPENSHIFT_REPO_DIR}tmp/ ]
    then
        client_message "Emptying tmp dir: ${OPENSHIFT_REPO_DIR}tmp/"
        rm -rf ${OPENSHIFT_REPO_DIR}tmp/* ${OPENSHIFT_REPO_DIR}tmp/.[^.]*
    fi
}

function pre-build() {
    ruby_tmp_dir=$OPENSHIFT_RUBY_DIR/tmp

    rm -rf ${ruby_tmp_dir}/.bundle ${ruby_tmp_dir}/vendor

    # If the previous and current commits didn't upload .bundle and you have .bundle and vendor/bundle already deployed then store away for redeploy
    # Also adding .openshift/markers/force_clean_build at the root of the repo will trigger a clean rebundle
    if ! git show master:.openshift/markers/force_clean_build > /dev/null 2>&1 && ! git show master:.bundle > /dev/null 2>&1 && ! git show master~1:.bundle > /dev/null 2>&1 && [ -d ${OPENSHIFT_REPO_DIR}.bundle ] && [ -d ${OPENSHIFT_REPO_DIR}vendor/bundle ]
    then
    echo 'Saving away previously bundled RubyGems'
    mv ${OPENSHIFT_REPO_DIR}.bundle ${ruby_tmp_dir}/
    mv ${OPENSHIFT_REPO_DIR}vendor ${ruby_tmp_dir}/
    fi
}

function build() {
    echo "Running build on Ruby cart"
    $OPENSHIFT_RUBY_DIR/bin/build
}

function post-deploy() {
    # Hot deployment support
    if hot_deploy_marker_is_present; then
      echo "Hot deploy marker is present. Touching Passenger restart.txt to trigger redeployment."
      touch ${OPENSHIFT_REPO_DIR}tmp/restart.txt
    fi
}

case "$1" in
  start)     start ;;
  stop)      stop ;;
  restart | reload )   restart $1 ;;
  status)    status ;;
  tidy)      tidy ;;
  pre-build) pre-build ;;
  build)     build ;;
  post-deploy) post-deploy ;;
  threaddump)
    ${OPENSHIFT_RUBY_DIR}bin/threaddump $OPENSHIFT_APP_NAME $OPENSHIFT_APP_UUID ;;
  *)         exit 0
esac
