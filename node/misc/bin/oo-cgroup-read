#!/usr/bin/ruby

# BZ 901449: SELinux failure prevent using "/usr/bin/env ruby".

require 'etc'
require 'open4'

# each value begins with the subsystem name and a dot (.)
# extract the subsystem name and check it against the list

# When combined with selinux, this script will allow users to read their own
# cgroups entries but not other users cgroups entries
euid = Process::Sys.geteuid
login = Etc.getpwuid(euid).name

attribute=ARGV[0]
unless attribute =~ /\A[a-zA-Z0-9\.\-_]*\z/
    puts "#{attribute} is an invalid attribute"
    exit 1
end

cmd = "cgget -n -v -r #{attribute} /openshift/#{login}"
# This would be simple, but we can't catch errors
#value = %x[%{cmd}]
pid, stdin, stdout, stderr = open4(cmd)

value = stdout.read.strip
error = stderr.read.strip

if not error == "" then
    $stderr.puts "Could not find attribute #{attribute}"
    $stderr.puts error
    exit 2
end

puts value
